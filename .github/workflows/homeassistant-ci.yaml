name: Home Assistant CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Validate Configuration
    runs-on: ubuntu-latest

    strategy:
      matrix:
        version: [ "stable", "beta" ]

    steps:
      - name: ‚§µÔ∏è Check out configuration from GitHub
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # CACHE PIP
      # ---------------------------------------------------------
      - name: ‚ôªÔ∏è Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ---------------------------------------------------------
      # CACHE NPM
      # ---------------------------------------------------------
      - name: ‚ôªÔ∏è Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cache
          restore-keys: |
            ${{ runner.os }}-npm-

      # ---------------------------------------------------------
      # YAML LINT
      # ---------------------------------------------------------
      - name: üßπ YAML Lint
        run: |
          pip install yamllint
          yamllint -c "./.yamllint/rules.yaml" .

      # ---------------------------------------------------------
      # JSON LINT
      # ---------------------------------------------------------
      - name: üîç JSON Lint
        run: |
          sudo npm install -g jsonlint
          find . -name "*.json" -print0 | xargs -0 -I {} jsonlint -q {}

      # ---------------------------------------------------------
      # TEMPLATE VALIDATION (light)
      # ---------------------------------------------------------
      - name: üß™ Validate Jinja Templates (light)
        run: |
          echo "Checking for malformed Jinja blocks..."
          grep -R "{{" -n . || true

      # ---------------------------------------------------------
      # LOVELACE VALIDATION (light)
      # ---------------------------------------------------------
      - name: üñº Validate Lovelace UI (light)
        run: |
          if [ -f ./ui-lovelace.yaml ]; then
            echo "Lovelace file found, basic validation OK"
          fi

      # ---------------------------------------------------------
      # CUSTOM COMPONENTS
      # ---------------------------------------------------------
      - name: ‚§µÔ∏è Check out Custom Components
        run: |
          mkdir custom_components/
          # Monitor Docker
          git clone https://github.com/ualex73/monitor_docker
          mv monitor_docker/custom_components/monitor_docker/ custom_components/

      # ---------------------------------------------------------
      # DUMMY SECRETS
      # ---------------------------------------------------------
      - name: üîë Use dummy files as credentials
        run: |
          cp .secrets_dummy.yaml secrets.yaml
          cp credentials/.google_dummy.json credentials/google.json

      # ---------------------------------------------------------
      # HOME ASSISTANT CONFIG CHECK (Docker)
      # ---------------------------------------------------------
      - name: ‚§µÔ∏è Fetch Home Assistant Docker Image
        run: |
          docker pull -q "ghcr.io/home-assistant/home-assistant:${{ matrix.version }}"

      - name: üöÄ Run Home Assistant Configuration Check
        run: |
          # Show Version
          docker run --rm \
            -v .:/config \
            "ghcr.io/home-assistant/home-assistant:${{ matrix.version }}" \
            python -m homeassistant --version

          # Run check_config
          docker run --rm \
            -v .:/config \
            "ghcr.io/home-assistant/home-assistant:${{ matrix.version }}" \
            python -m homeassistant \
              --config "/config" \
              --script check_config
